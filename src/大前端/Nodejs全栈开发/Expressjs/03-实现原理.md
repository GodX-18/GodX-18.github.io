---
title: 实现原理
order: 3
category:
  - 服务端框架
tag:
  - Express
---

## 源码结构

![image-20240322140145760](https://raw.githubusercontent.com/GodX-18/picBed/main/image-20240322140145760.png)

1. 首先我们去 `package.json`文件中查找 `main`字段来确定入口文件在哪里

2. 但是我们并没有发现`main`字段，说明入口文件是根目录下的`index.js`文件

   ```js
   module.exports = require('./lib/express');
   ```

3. 我们又发现`index.js`文件引用了`./lib/express`导出的模块，其它的代码文件都是来辅助实现 `express.js` 

   ```js
   // express.js 部分代码
   exports = module.exports = createApplication;
   
   function createApplication() {
     var app = function(req, res, next) {
       app.handle(req, res, next);
     };
   
     mixin(app, EventEmitter.prototype, false);
     mixin(app, proto, false);
   
     // expose the prototype that will get set on requests
     app.request = Object.create(req, {
       app: { configurable: true, enumerable: true, writable: true, value: app }
     })
   
     // expose the prototype that will get set on responses
     app.response = Object.create(res, {
       app: { configurable: true, enumerable: true, writable: true, value: app }
     })
   
     app.init();
     return app;
   }
   ```

4. 至此我们大概了解了express 的源码结构

## 快速体验

### 目标

自己实现一个简易的 express 替代 express 以实现相同的功能

### 源码

```js
//  express.js
const http = require("http");
const url = require("url");

const routes = [
  // { path: "", method: "", handler: () => {} },
  // { path: "", method: "", handler: () => {} },
  // { path: "", method: "", handler: () => {} }
];

function createApplication() {
  return {
    // 把路由收集起来
    get(path, handler) {
      routes.push({
        path,
        method: "get",
        handler
      });
    },
    listen(...args) {
      const server = http.createServer((req, res) => {
        const { pathname } = url.parse(req.url);
        const method = req.method.toLowerCase();
        const route = routes.find((route) => route.path === pathname && route.method === method);
        if (route) {
          return route.handler(req, res);
        }
        res.end("404 Not Found");
      });
      server.listen(...args);
    }
  };
}

module.exports = createApplication;
```

### 使用

```js
// app.js
const express = require("./express");
const app = express();
const port = 3000;

app.get("/", (req, res) => {
  res.end("Hello World!");
});

app.get("/zx", (req, res) => {
  res.end("zx2!");
});

app.listen(port, () => {
  console.log("GodX------>log服务端应用已经启动在 3000 端口");
});
```

## 抽取 App 模块

由于具体的实现都写死在 `createApplication`函数中，不方便扩展与维护。更好的做法是将返回的对象包装到一个构造函数来实现然后提取出来，这样管理维护起来会更加方便。

```js
// application.js
const http = require("http");
const url = require("url");

function App() {
  this.routes = [];
}

App.prototype.get = function (path, handler) {
  this.routes.push({
    path,
    method: "get",
    handler
  });
};

App.prototype.listen = function (...args) {
  const server = http.createServer((req, res) => {
    const { pathname } = url.parse(req.url);
    const method = req.method.toLowerCase();
    const route = this.routes.find((route) => route.path === pathname && route.method === method);
    if (route) {
      return route.handler(req, res);
    }
    res.end("404 Not Found");
  });
  server.listen(...args);
};

module.exports = App;
```

```js
// express.js
const App = require("./application");

function createApplication() {
  const app = new App();
  return app;
}

module.exports = createApplication;
```

## 提取路由模块

为了更方便的开发和管理，接下来我们继续将路由相关逻辑单独封装到一个模块当中。新建 `lib/router/index.js`文件

```js
const url = require("url");

function Router() {
  this.stack = [];
}

Router.prototype.get = function (path, handler) {
  this.stack.push({
    path,
    method: "get",
    handler
  });
};

Router.prototype.handler = function (req, res) {
  const { pathname } = url.parse(req.url);
  const method = req.method.toLowerCase();
  const route = this.stack.find((route) => route.path === pathname && route.method === method);
  if (route) {
    return route.handler(req, res);
  }
  res.end("404 Not Found");
};

module.exports = Router;
```

修改 `express.js`文件

```js
const App = require("./application");

function createApplication() {
  const app = new App();
  return app;
}

module.exports = createApplication;
```



